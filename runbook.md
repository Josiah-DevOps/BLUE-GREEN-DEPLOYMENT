


# Blue-Green Deployment Alert Runbook

## Overview
This runbook documents the alerts generated by the Blue-Green Deployment system, their meanings, and the recommended actions for operators. Alerts are sent to the configured Slack channel.


## Alert Types

### 1. Failover Detected
**Meaning:**  
The system detected that the active pool has switched from `blue` to `green` or vice versa. This usually occurs because the primary pool failed health checks or returned errors.

**Slack Message Example:**


 *Failover Detected*
Pool switched: blue → green
Details:
• Pool: green
• Release: green-release-001
• Upstream Status: 500
• Upstream Addr: -
• Request Time: 0.014s
• Upstream Response Time: -



**Operator Actions:**
1. Confirm that the failed pool is actually down:
   ```bash
   docker compose ps
   docker compose logs app_blue
   docker compose logs app_green

2. Investigate upstream service errors (500, 502, 503, 504) in Nginx logs:

   ```bash
   docker compose exec alert_watcher tail -f /var/log/nginx/access.log
3. Check deployment logs for the pool that failed.
4. Restore failed pool if necessary and ensure health checks pass.


### 2.High Error Rate

**Meaning:**
The error rate for 5xx responses has exceeded the configured threshold (default 2%). The system triggers this alert if backend services are consistently failing.

**Slack Message Example:**


 Slack Alert – High Error Rate
Error-rate alert triggered (>2%)
Current 5xx rate: 35.00%

**Operator Actions:**

1. Identify which pool is failing using logs:

   bash
   docker compose exec alert_watcher tail -n 50 /var/log/nginx/access.log
   
2. Inspect application logs for errors.
3. Restart or rollback the failing pool if needed.
4. Ensure health checks succeed before returning traffic.



### 3.Recovery Detected

**Meaning:**
The error rate has returned below the recovery threshold (50% of ERROR_RATE_THRESHOLD). The system indicates that services are stable.

**Slack Message Example:**


Recovery Detected
5xx rate back to 0.50%
```

**Operator Actions:**

1. Confirm both pools are healthy:

   ```bash
   docker compose ps

2. Resume normal monitoring.
3. Document any corrective actions taken.



## Nginx Log Fields

Each access log includes:

| Field                  | Description                     |
| ---------------------- | ------------------------------- |
| remote_addr            | Client IP                       |
| time_local             | Timestamp                       |
| pool                   | Active pool (`blue` or `green`) |
| release                | Release ID of the app           |
| upstream_status        | HTTP status from upstream       |
| upstream_addr          | Address of upstream service     |
| request_time           | Total request time (s)          |
| upstream_response_time | Upstream response time (s)      |

---

## General Notes

* Containers: `app_blue`, `app_green`, `nginx`, `alert_watcher`
* Logs: `/var/log/nginx/access.log` (access), `/var/log/nginx/error.log` (errors)
* Slack webhook must be set in `.env` as `SLACK_WEBHOOK_URL`.
* Health checks:

  ```yaml
  CMD-SHELL: wget -qO- http://localhost:3000/healthz || exit 1
  ```
* Failover detection triggers **only** when pool changes.





